# ASTRACAT_GUARD - Защита уже запущенного Docker Caddy

## Обзор

Этот документ описывает, как защитить уже запущенный контейнер Caddy с помощью ASTRACAT_GUARD **без остановки или перезапуска** оригинального контейнера.

## Особенности автоматической защиты

- **Нет необходимости останавливать** действующий Caddy контейнер
- **Автоматическое обнаружение** контейнера по имени или портам
- **Подключение к логам** без изменения оригинальной конфигурации
- **Защита в реальном времени** через iptables хоста
- **Минимальное вмешательство** в работу существующей системы

## Быстрый старт

### 1. Установка зависимостей

```bash
pip install docker psutil netifaces netaddr
```

### 2. Запуск автоматической защиты

```bash
# Проверить информацию о Caddy контейнере
sudo ./scripts/auto_connect_existing.sh info

# Запустить защиту
sudo ./scripts/auto_connect_existing.sh start

# Проверить статус
sudo ./scripts/auto_connect_existing.sh status
```

## Как это работает

### 1. Автоматическое обнаружение

Система автоматически:
- Находит запущенный контейнер Caddy по имени или используемым портам
- Подключается к потоку логов контейнера
- Начинает анализ трафика без изменения оригинальной конфигурации

### 2. Анализ и защита

- Мониторинг логов Caddy в реальном времени
- Автоматическое определение аномального поведения
- Блокировка подозрительных IP через iptables хоста
- Адаптивная настройка порогов на основе нормального трафика

### 3. Прозрачная защита

- Caddy продолжает работать без изменений
- Никаких изменений в оригинальный контейнер
- Защита работает как отдельный сервис
- Блокировки применяются на уровне хоста

## Использование

### Проверка системы

```bash
# Проверить информацию о найденном Caddy
sudo ./scripts/auto_connect_existing.sh info

# Найти и показать все запущенные контейнеры с Caddy
docker ps | grep -i caddy
```

### Управление защитой

```bash
# Запустить защиту
sudo ./scripts/auto_connect_existing.sh start

# Проверить статус
sudo ./scripts/auto_connect_existing.sh status

# Остановить защиту
sudo ./scripts/auto_connect_existing.sh stop

# Перезапустить защиту
sudo ./scripts/auto_connect_existing.sh restart
```

### Мониторинг

Основные логи защиты: `/var/log/astracat_guard_auto.log`

Просмотреть логи защиты в реальном времени:
```bash
tail -f /var/log/astracat_guard_auto.log
```

## Технические детали

### Автообнаружение контейнера

Система ищет контейнер по:
1. Имени или образу (содержащему "caddy")
2. Используемым портам (80, 443, 2019)
3. Запущенным процессам

### Подключение к логам

Используются следующие методы:
1. Прямое подключение к потоку логов Docker
2. Альтернативный сетевой анализ трафика
3. Фолбэк на системный мониторинг

### Блокировки

Блокировки применяются через:
- iptables на хост-системе
- Без изменения контейнера Caddy
- Влияют на весь трафик на хосте

## Пример сценария использования

1. У вас запущен Caddy в Docker: `docker run -d --name my-caddy -p 80:80 -p 443:443 caddy:latest`
2. Вы запускаете: `sudo ./scripts/auto_connect_existing.sh start`
3. Система находит контейнер `my-caddy`
4. Начинается мониторинг его логов
5. Нет необходимости останавливать или изменять `my-caddy`
6. Защита начинает работать

## Безопасность

- Защита работает изолированно от основного контейнера
- Никаких изменений в оригинальный образ или контейнер
- Применяются минимально необходимые привилегии
- Блокировки на уровне системы, не влияют на Docker сеть

## Устранение неполадок

### Контейнер не найден

Если система не находит контейнер:
```bash
# Проверьте список всех контейнеров
docker ps -a

# Убедитесь, что контейнер использует стандартные порты
docker port <container_name>

# Убедитесь, что у вас есть права на доступ к Docker
sudo usermod -aG docker $USER
```

### Нет доступа к логам

Если нет доступа к потоку логов:
- Проверьте права доступа к Docker
- Убедитесь, что система может читать поток логов
- Альтернативный метод будет использован автоматически

### Проблемы с блокировками

Если блокировки не применяются:
- Проверьте права на выполнение iptables
- Убедитесь, что вы запускаете с sudo
- Проверьте наличие необходимых capabilities

## Преимущества

1. **Никаких изменений** в существующий контейнер
2. **Без остановки** основного сервиса
3. **Автоматическая защита** без настройки
4. **Реальное время** анализа трафика
5. **Адаптивные пороги** защиты

Система позволяет добавить мощную защиту к уже работающему Caddy без какого-либо вмешательства в его работу!